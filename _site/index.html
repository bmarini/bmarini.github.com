<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>Ben Marini</title>
	<link rel="stylesheet" href="/css/syntax.css" type="text/css" media="screen" charset="utf-8" />
	<link rel="stylesheet" href="/css/master.css" type="text/css" media="screen" charset="utf-8" />
</head>
<body>
  <div id="wrapper">
    
<dl class="post">
  <dt>Bundler's DSL implementation</dt>
  <dd class="date">28 Dec 2010</dd>
  <dd class="content">
    <p>Here is an implementation of a real basic DSL. The implementation was lifted from <a href='https://github.com/carlhuda/bundler/blob/1-0-stable/lib/bundler/dsl.rb'>bundler</a></p>
<script src='https://gist.github.com/757889.js'> </script>
  </dd>
</dl>
  
<h1 class="separator">&hellip;</h1>
  

<dl class="post">
  <dt>The case for case statements</dt>
  <dd class="date">18 Apr 2009</dd>
  <dd class="content">
    <p>Your rails app that serves up image files needs to set the &#8220;Content-type&#8221; in the header to match the files. Since we are only using jpegs, this is very easy.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a jpeg</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;image/jpeg&#39;</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>But now you are serving up gifs also. No problem, just update the fetch method.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif or jpeg</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>

    <span class='k'>if</span> <span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;gif&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>else</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>end</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>That if else statement looks way too wordy, how about ternary style.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif or jpeg</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    <span class='n'>content_type</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;gif&#39;</span><span class='p'>)</span> <span class='p'>?</span> <span class='s1'>&#39;image/gif&#39;</span> <span class='p'>:</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>So, if the file is a gif, set the content type to &#8216;image/gif&#8217;, otherwise default to &#8216;image/jpeg&#8217;. This is alright only because we know we aren&#8217;t serving up any other file types. Or at least that&#8217;s what we tell ourselves isn&#8217;t it.</p>

<p>Are you disgusted with this code already? Good. I am too.</p>

<p>Can you guess what happens next? Of course, now we need to support another file type, PNGs. No problem! We&#8217;ll have to switch the logic though&#8230;and while we&#8217;re at it, let&#8217;s raise an exception if the extension of the file isn&#8217;t one that we expect.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif, jpeg or png</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    
    <span class='k'>if</span> <span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;gif&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>elsif</span> <span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;jpg&#39;</span> <span class='o'>||</span> <span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;jpeg&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>elsif</span> <span class='n'>ext</span> <span class='o'>==</span> <span class='s1'>&#39;png&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>else</span>
      <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>While this isn&#8217;t terrible, it&#8217;s staring to look messy. A lazy coder would leave it like this, and would probably continue to copy and paste elsif statements downward if we needed to support more file types. What we really need to do here is change this to a case statement.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif, jpeg or png</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    
    <span class='k'>case</span> <span class='n'>ext</span>
    <span class='k'>when</span> <span class='s1'>&#39;gif&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;jpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;jpeg&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;png&#39;</span>
      <span class='n'>content_type</span> <span class='o'>=</span> <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>else</span>
      <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>This is definitely more readable. We can do better though.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif, jpeg or png</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    
    <span class='n'>content_type</span> <span class='o'>=</span> <span class='k'>case</span> <span class='n'>ext</span>
    <span class='k'>when</span> <span class='s1'>&#39;gif&#39;</span>
      <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;jpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;jpeg&#39;</span>
      <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;png&#39;</span>
      <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>else</span>
      <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>Wait, we can do better than that.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif, jpeg or png</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span> <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    
    <span class='n'>content_type</span> <span class='o'>=</span> <span class='k'>case</span> <span class='n'>ext</span>
    <span class='k'>when</span> <span class='s1'>&#39;gif&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;jpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;jpeg&#39;</span> <span class='p'>:</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;png&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>else</span> <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
    
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>This is looking much nicer. At this point or earlier you might have realized that you really need this extension logic in a separate method. Let&#8217;s see how that looks.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes a path to a gif, jpeg or png</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
  <span class='k'>end</span>
  
  <span class='k'>def</span> <span class='nf'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='k'>case</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    <span class='k'>when</span> <span class='s1'>&#39;gif&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;jpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;jpeg&#39;</span> <span class='p'>:</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;png&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>else</span> <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>As an added bonus we were able to remove the variable assignment since the method will return the value of the last statement, in the case the case statement.</p>

<p>Let&#8217;s pretend it&#8217;s been a few months, and now we&#8217;ve realized we need support for not just images but video files.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes images and video files</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
  <span class='k'>end</span>
  
  <span class='k'>def</span> <span class='nf'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='k'>case</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    <span class='k'>when</span> <span class='s1'>&#39;gif&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/gif&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;jpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;jpeg&#39;</span> <span class='p'>:</span> <span class='s1'>&#39;image/jpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;png&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;image/png&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;mov&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;video/quicktime&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;mpg&#39;</span><span class='p'>,</span> <span class='s1'>&#39;mpeg&#39;</span> <span class='p'>:</span> <span class='s1'>&#39;video/mpeg&#39;</span>
    <span class='k'>when</span> <span class='s1'>&#39;avi&#39;</span>         <span class='p'>:</span> <span class='s1'>&#39;video/x-msvideo&#39;</span>
    <span class='k'>else</span> <span class='k'>raise</span> <span class='s2'>&quot;This file type is unsupported&quot;</span>
    <span class='k'>end</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>Not too bad. But now imagine we want to add support for a whole host of other files. Let&#8217;s say this will add 100 lines to this case statement. We have outgrown our case statement at this point. We need a hash.</p>
<div class='highlight'><pre><code class='ruby'>  <span class='c1'># Takes any file</span>
  <span class='k'>def</span> <span class='nf'>fetch</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>send_file</span> <span class='n'>filename</span><span class='p'>,</span> <span class='ss'>:type</span> <span class='o'>=&gt;</span> <span class='n'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
  <span class='k'>end</span>
  
  <span class='k'>def</span> <span class='nf'>content_type</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span>
    <span class='n'>ext</span>  <span class='o'>=</span> <span class='no'>File</span><span class='o'>.</span><span class='n'>extname</span><span class='p'>(</span><span class='n'>filename</span><span class='p'>)</span><span class='o'>[</span><span class='mi'>1</span><span class='o'>.</span><span class='n'>.</span><span class='o'>-</span><span class='mi'>1</span><span class='o'>]</span>
    <span class='n'>content_hash</span><span class='o'>[</span><span class='n'>ext</span><span class='o'>]</span> <span class='o'>||</span> <span class='k'>raise</span><span class='p'>(</span><span class='s2'>&quot;This file type is unsupported&quot;</span><span class='p'>)</span>
  <span class='k'>end</span>
  
  <span class='k'>def</span> <span class='nf'>content_hash</span>
    <span class='p'>{</span>
      <span class='s1'>&#39;gif&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;image/gif&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;jpg&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;image/jpeg&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;jpeg&#39;</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;image/jpeg&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;png&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;image/png&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;mov&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;video/quicktime&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;mpg&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;video/mpeg&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;mpeg&#39;</span> <span class='o'>=&gt;</span> <span class='s1'>&#39;video/mpeg&#39;</span><span class='p'>,</span>
      <span class='s1'>&#39;avi&#39;</span>  <span class='o'>=&gt;</span> <span class='s1'>&#39;video/x-msvideo&#39;</span>
    <span class='p'>}</span>
  <span class='k'>end</span>
</code></pre>
</div>
<p>We&#8217;ve gone from having our extension to content type mappings imbedded in a control structure (the case statement), to storing the extension to content type mappings in a data structure ( a Hash ).</p>

<p>This opens up some opportunities for us. If our list of content types grew to the hundreds, we could move them into a csv file or yaml file. This file would be loaded into a Hash.</p>
  </dd>
</dl>
  


  </div>
</body>
</html>
